<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Duk Cybersecurity Lab Register</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .container { max-width: 600px; margin: 0 auto; }
        .card { background-color: white; padding: 2rem; border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); margin-top: 1.5rem; }
        .btn { display: inline-block; padding: 0.75rem 1.5rem; border-radius: 0.5rem; font-weight: 600; text-align: center; cursor: pointer; transition: background-color 0.3s ease; width: 100%; border: none; }
        .btn-primary { background-color: #4f46e5; color: white; }
        .btn-primary:hover { background-color: #4338ca; }
        .btn-danger { background-color: #dc2626; color: white; }
        .btn-danger:hover { background-color: #b91c1c; }
        .btn-secondary { background-color: #6b7280; color: white; }
        .btn-secondary:hover { background-color: #4b5563; }
        .btn-outline { background-color: transparent; color: #4f46e5; border: 1px solid #4f46e5; }
        .btn-outline:hover { background-color: #e0e7ff; }
        .input-field { width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 0.5rem; margin-bottom: 1rem; }
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 1000; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; }
        .modal.active { opacity: 1; visibility: visible; }
        .modal-content { background-color: white; padding: 2rem; border-radius: 0.75rem; box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1); width: 90%; max-width: 400px; text-align: center; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #4f46e5; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 1rem auto; }
        [style*="display: none"] { display: none !important; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="p-4 sm:p-6">

    <div class="container">
        <!-- Student Login Section -->
        <div id="loginSection" class="card">
            <h1 class="text-xl font-bold text-center mb-4">Duk Cybersecurity Lab Register</h1>
            <input type="text" id="rollNumberInput" class="input-field" placeholder="Enter Your Roll Number">
            <button id="submitRollNumber" class="btn btn-primary">Submit</button>
            <div id="loginLoader" class="loader" style="display: none;"></div>
            <p id="loginError" class="text-red-500 text-center mt-4" style="display: none;"></p>
        </div>

        <!-- Admin Login Section -->
        <div id="adminLoginSection" class="card" style="display: none;">
            <button class="back-to-login mb-4 text-gray-600 hover:text-gray-900">&larr; Back</button>
            <h1 class="text-xl font-bold text-center mb-4">Admin Login</h1>
            <input type="password" id="adminPasswordInput" class="input-field" placeholder="Enter Admin Password">
            <button id="submitAdminPassword" class="btn btn-primary">Login</button>
            <div id="adminLoginLoader" class="loader" style="display: none;"></div>
            <p id="adminLoginError" class="text-red-500 text-center mt-4" style="display: none;"></p>
        </div>

        <!-- Student App Section -->
        <div id="appSection" class="card" style="display: none;">
            <h2 class="text-xl font-semibold text-center mb-2">Welcome, <span id="studentName"></span>!</h2>
            <p class="text-center text-gray-500 mb-6" id="studentRollNumber"></p>
            <div id="actionButtons">
                 <button id="enterBtn" class="btn btn-primary mb-4">Enter Lab</button>
                 <button id="exitBtn" class="btn btn-danger" style="display: none;">Exit Lab</button>
            </div>
             <div id="actionLoader" class="loader" style="display: none;"></div>
            <button id="historyBtn" class="btn btn-secondary">View My History</button>
            <button id="studentLogoutBtn" class="btn btn-outline mt-3">Logout</button>
        </div>

        <!-- Student History Section -->
        <div id="historySection" class="card" style="display: none;">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">My Lab History</h2>
                <button class="back-to-app text-gray-600 hover:text-gray-900">&larr; Back</button>
            </div>
             <div id="historyLoader" class="loader" style="display: none;"></div>
            <div id="historyContent" class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50"><tr><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Entry</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Exit</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Duration</th></tr></thead>
                    <tbody id="historyTableBody" class="bg-white divide-y divide-gray-200"></tbody>
                </table>
                 <p id="noHistory" class="text-center text-gray-500 py-4" style="display: none;">No history found.</p>
            </div>
        </div>

        <!-- Admin Dashboard Section -->
        <div id="adminDashboardSection" class="card" style="display: none;">
            <div class="flex justify-between items-center mb-6">
                <h1 class="text-2xl font-bold">Admin Dashboard</h1>
                <button id="adminLogoutBtn" class="btn btn-danger !w-auto !py-2">Logout</button>
            </div>
            
            <div class="mb-8">
                <h2 class="text-xl font-semibold mb-3">Currently in Lab (<span id="currentlyInLabCount">0</span>)</h2>
                <div id="currentlyInLabLoader" class="loader" style="display: none;"></div>
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50"><tr><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Name</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Roll No</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Entry Time</th></tr></thead>
                    <tbody id="currentlyInLabTableBody" class="bg-white divide-y divide-gray-200"></tbody>
                </table>
                <p id="noOneInLab" class="text-center text-gray-500 py-4" style="display: none;">The lab is currently empty.</p>
            </div>

            <div>
                <h2 class="text-xl font-semibold mb-3">View History by Date</h2>
                <div class="flex items-center space-x-2 mb-4">
                    <input type="date" id="historyDateInput" class="input-field !mb-0">
                    <button id="viewDateHistoryBtn" class="btn btn-primary !w-auto">View</button>
                </div>
                <div id="dateHistoryLoader" class="loader" style="display: none;"></div>
                <table class="min-w-full divide-y divide-gray-200">
                     <thead class="bg-gray-50"><tr><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Name</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Roll No</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Entry</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Exit</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Duration</th></tr></thead>
                    <tbody id="dateHistoryTableBody" class="bg-white divide-y divide-gray-200"></tbody>
                </table>
                 <p id="noDateHistory" class="text-center text-gray-500 py-4" style="display: none;">No records found for the selected date.</p>
            </div>
        </div>

    </div>

    <div id="messageModal" class="modal"><div class="modal-content"><p id="modalMessage" class="text-lg mb-4"></p><button id="modalCloseBtn" class="btn btn-primary">OK</button></div></div>

    <script>
        const GOOGLE_APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyBqwhTjWnwftpQSBJO-u1TFn9R685w2Fp5jj53YkBVTNWINmv4jjSkdUOP4WWiDBjl/exec';

        const allViews = document.querySelectorAll('.card');
        const loginSection = document.getElementById('loginSection');
        const appSection = document.getElementById('appSection');
        const historySection = document.getElementById('historySection');
        const adminLoginSection = document.getElementById('adminLoginSection');
        const adminDashboardSection = document.getElementById('adminDashboardSection');

        let currentUser = null;
        let entryTime = null;

        const showView = (viewToShow) => allViews.forEach(v => v.style.display = v.id === viewToShow.id ? 'block' : 'none');
        const showLoader = (loader) => document.getElementById(loader).style.display = 'block';
        const hideLoader = (loader) => document.getElementById(loader).style.display = 'none';
        const showError = (el, msg) => { const e = document.getElementById(el); e.textContent = msg; e.style.display = 'block'; };
        const hideError = (el) => document.getElementById(el).style.display = 'none';

        function showModal(message) {
            document.getElementById('modalMessage').textContent = message;
            document.getElementById('messageModal').classList.add('active');
        }

        document.getElementById('submitRollNumber').addEventListener('click', handleUserVerification);
        document.getElementById('submitAdminPassword').addEventListener('click', handleAdminLogin);
        document.getElementById('modalCloseBtn').addEventListener('click', () => document.getElementById('messageModal').classList.remove('active'));
        document.querySelector('.back-to-login').addEventListener('click', () => {
            document.getElementById('adminPasswordInput').value = '';
            showView(loginSection);
        });
        
        document.getElementById('enterBtn').addEventListener('click', () => handleLabAction('entry'));
        document.getElementById('exitBtn').addEventListener('click', () => handleLabAction('exit'));
        document.getElementById('historyBtn').addEventListener('click', showStudentHistory);
        document.getElementById('studentLogoutBtn').addEventListener('click', handleStudentLogout);
        document.querySelectorAll('.back-to-app').forEach(btn => btn.addEventListener('click', () => showView(appSection)));

        document.getElementById('adminLogoutBtn').addEventListener('click', () => {
            document.getElementById('adminPasswordInput').value = '';
            showView(loginSection);
        });
        document.getElementById('viewDateHistoryBtn').addEventListener('click', fetchDateHistory);

        async function handleUserVerification() {
            const rollNumber = document.getElementById('rollNumberInput').value.trim();
            if (!rollNumber) { showError('loginError', "Please enter your roll number."); return; }
            
            hideError('loginError');
            showLoader('loginLoader');
            document.getElementById('submitRollNumber').disabled = true;

            try {
                const response = await fetch(`${GOOGLE_APPS_SCRIPT_URL}?action=verifyUser&rollNumber=${rollNumber}`);
                if(!response.ok) throw new Error(`Server error: ${response.statusText}`);
                const result = await response.json();

                if (result.role === 'student') {
                    currentUser = { rollNumber, name: result.name };
                    document.getElementById('studentName').textContent = currentUser.name;
                    document.getElementById('studentRollNumber').textContent = `Roll No: ${currentUser.rollNumber}`;
                    const storedEntryTime = localStorage.getItem(`entryTime_${currentUser.rollNumber}`);
                    if (storedEntryTime) {
                        entryTime = new Date(storedEntryTime);
                        showExitButton();
                    } else {
                        showEnterButton();
                    }
                    showView(appSection);
                } else if (result.role === 'admin') {
                    showView(adminLoginSection);
                } else {
                    showError('loginError', "Roll number not found.");
                }
            } catch (error) {
                showError('loginError', `Verification failed: ${error.message}`);
            } finally {
                hideLoader('loginLoader');
                document.getElementById('submitRollNumber').disabled = false;
                document.getElementById('rollNumberInput').value = '';
            }
        }

        async function handleAdminLogin() {
            const password = document.getElementById('adminPasswordInput').value;
            if (!password) { showError('adminLoginError', "Please enter the password."); return; }
            
            hideError('adminLoginError');
            showLoader('adminLoginLoader');
            document.getElementById('submitAdminPassword').disabled = true;

            try {
                const response = await fetch(`${GOOGLE_APPS_SCRIPT_URL}?action=verifyAdmin&password=${password}`);
                if(!response.ok) throw new Error(`Server error: ${response.statusText}`);
                const result = await response.json();

                if (result.success) {
                    showView(adminDashboardSection);
                    fetchCurrentlyInLab();
                    document.getElementById('historyDateInput').valueAsDate = new Date();
                    fetchDateHistory();
                } else {
                    showError('adminLoginError', "Incorrect password.");
                }
            } catch(error) {
                showError('adminLoginError', `Login failed: ${error.message}`);
            } finally {
                 hideLoader('adminLoginLoader');
                 document.getElementById('submitAdminPassword').disabled = false;
            }
        }

        const showEnterButton = () => { document.getElementById('enterBtn').style.display = 'block'; document.getElementById('exitBtn').style.display = 'none'; };
        const showExitButton = () => { document.getElementById('enterBtn').style.display = 'none'; document.getElementById('exitBtn').style.display = 'block'; };

        async function handleLabAction(action) {
            showLoader('actionLoader');
            document.getElementById('enterBtn').style.display = 'none';
            document.getElementById('exitBtn').style.display = 'none';

            try {
                if (action === 'entry') {
                    entryTime = new Date();
                    localStorage.setItem(`entryTime_${currentUser.rollNumber}`, entryTime.toISOString());
                    await logToGoogleSheet('entry', entryTime);
                    showModal('Entry confirmed successfully!');
                    showExitButton();
                } else if (action === 'exit') {
                    const exitTime = new Date();
                    const durationMs = exitTime - entryTime;
                    const durationStr = formatDuration(durationMs);
                    await logToGoogleSheet('exit', exitTime, durationStr);
                    localStorage.removeItem(`entryTime_${currentUser.rollNumber}`);
                    entryTime = null;
                    showModal(`You spent ${durationStr} in the lab. Thank you.`);
                    showEnterButton();
                }
            } catch (error) {
                showModal(`An unexpected error occurred: ${error.message}`);
                entryTime ? showExitButton() : showEnterButton();
            } finally {
                hideLoader('actionLoader');
            }
        }
        
        function handleStudentLogout() {
            currentUser = null;
            entryTime = null;
            document.getElementById('rollNumberInput').value = '';
            showView(loginSection);
        }

        async function logToGoogleSheet(action, time, duration = '') {
            const data = { rollNumber: currentUser.rollNumber, name: currentUser.name, action, timestamp: time.toLocaleString(), duration };
            await fetch(GOOGLE_APPS_SCRIPT_URL, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
        }

        async function showStudentHistory() {
            showView(historySection);
            showLoader('historyLoader');
            const tableBody = document.getElementById('historyTableBody');
            tableBody.innerHTML = '';
            document.getElementById('noHistory').style.display = 'none';

            try {
                const response = await fetch(`${GOOGLE_APPS_SCRIPT_URL}?action=getStudentHistory&rollNumber=${currentUser.rollNumber}`);
                if(!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();
                if (data.history && data.history.length > 0) {
                    data.history.forEach(row => {
                        const tr = tableBody.insertRow();
                        tr.innerHTML = `<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${row.entry || 'N/A'}</td><td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${row.exit || 'N/A'}</td><td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${row.duration || 'N/A'}</td>`;
                    });
                } else {
                    document.getElementById('noHistory').style.display = 'block';
                }
            } catch (error) {
                showModal('Could not fetch history. ' + error.message);
            } finally {
                hideLoader('historyLoader');
            }
        }

        async function fetchCurrentlyInLab() {
            showLoader('currentlyInLabLoader');
            const tableBody = document.getElementById('currentlyInLabTableBody');
            tableBody.innerHTML = '';
            document.getElementById('noOneInLab').style.display = 'none';

            try {
                const response = await fetch(`${GOOGLE_APPS_SCRIPT_URL}?action=getCurrentlyInLab`);
                if(!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();
                document.getElementById('currentlyInLabCount').textContent = data.inLab.length;
                if (data.inLab && data.inLab.length > 0) {
                    data.inLab.forEach(s => {
                        const tr = tableBody.insertRow();
                        tr.innerHTML = `<td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${s.name}</td><td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${s.rollNumber}</td><td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${s.entryTime}</td>`;
                    });
                } else {
                    document.getElementById('noOneInLab').style.display = 'block';
                }
            } catch (e) {
                showModal('Could not fetch current lab status. ' + e.message);
            } finally {
                hideLoader('currentlyInLabLoader');
            }
        }

        async function fetchDateHistory() {
            const date = document.getElementById('historyDateInput').value;
            if (!date) { showModal("Please select a date."); return; }
            showLoader('dateHistoryLoader');
            const tableBody = document.getElementById('dateHistoryTableBody');
            tableBody.innerHTML = '';
            document.getElementById('noDateHistory').style.display = 'none';

            try {
                const response = await fetch(`${GOOGLE_APPS_SCRIPT_URL}?action=getDateHistory&date=${date}`);
                if(!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();
                if (data.history && data.history.length > 0) {
                    data.history.forEach(row => {
                         const tr = tableBody.insertRow();
                         tr.innerHTML = `<td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${row.name}</td><td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${row.rollNumber}</td><td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${row.entry || 'N/A'}</td><td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${row.exit || 'N/A'}</td><td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${row.duration || 'N/A'}</td>`;
                    });
                } else {
                    document.getElementById('noDateHistory').style.display = 'block';
                }
            } catch (e) {
                showModal('Could not fetch history for the selected date. ' + e.message);
            } finally {
                hideLoader('dateHistoryLoader');
            }
        }

        function formatDuration(ms) { const s = Math.floor((ms/1000)%60).toString().padStart(2,'0'); const m = Math.floor((ms/(1000*60))%60).toString().padStart(2,'0'); const h = Math.floor((ms/(1000*60*60))%24).toString().padStart(2,'0'); return `${h}:${m}:${s}`; }

        document.addEventListener('DOMContentLoaded', () => {
            showView(loginSection);
        });

    </script>
</body>
</html>

